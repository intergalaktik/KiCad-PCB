name: Export JLCPCB Production Files

on:
  push:
    branches:
      - main    
    tags:
      - "v*.*.*"    

permissions:
  contents: write  # Allow pushing and creating releases

jobs:
  build:
    name: Generate fabrication and assembly files
    runs-on: ubuntu-latest
    container: ghcr.io/inti-cmnb/kicad9_auto_full:dev

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed for pushing back changes

      - name: Check KiCad version
        run: |
          kicad-cli --version

      - name: Run KiBot (Gerbers, BOM, CPL, PDF, 3D)
        uses: INTI-CMNB/KiBot@dev
        with:
          config: hardware/output.kibot.yaml
          board: 'hardware/intergalaktik.kicad_pcb'
          schema: 'hardware/intergalaktik.kicad_sch'
          dir: production
          install3D: true
          verbose: true

      - name: Commit generated files to production folder
        if: github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Prevent infinite CI loops (skip workflow on commit)
          if [ -n "$(git status --porcelain production)" ]; then
            git add production/
            git commit -m "Update production files [skip ci]"
            git push origin main
          else
            echo "No changes to commit."
          fi

      - name: Install zip
        run: sudo apt-get update && sudo apt-get install -y zip

      - name: Create release archive
        run: |
          mkdir -p artifacts
          zip -r artifacts/jlcpcb_production.zip production/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/jlcpcb_production.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}